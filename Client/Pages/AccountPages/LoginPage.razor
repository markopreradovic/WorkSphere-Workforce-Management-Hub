@page "/identity/account/login"
@layout AuthenticationLayout
<div class="container">
    <div class="row">
        <div class="col-lg-4"> </div>
        <div class="col-lg-4">
            <EditForm Enhance Model="User" OnValidSubmit="HandleLogin">
                <DataAnnotationsValidator />
                <div class="card shadow-lg" style="margin-top:10vh; border-radius:20px; overflow:hidden; border:none; backdrop-filter: blur(10px); background: rgba(26, 32, 44, 0.85);">
                    <div class="card-header text-center border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem 1rem;">
                        <div class="mb-3">
                            <img style="border-radius:50%; box-shadow: 0 8px 16px rgba(0,0,0,0.3);" src="../images/companylogos/logo.png" height="80" width="80" />
                        </div>
                        <h3 class="mb-0" style="color: white; font-weight: 600; letter-spacing: 0.5px;">Welcome Back</h3>
                        <p class="mb-0 mt-2" style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Sign in to continue</p>
                    </div>
                    <div class="card-body" style="padding: 2.5rem 2rem;">
                        <div class="form-group mb-4">
                            <label class="form-label" style="color: #e2e8f0; font-weight: 500; margin-bottom: 0.5rem;">Email Address</label>
                            <InputText @bind-Value="User.Email" class="form-control" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 0.75rem 1rem; color: white; transition: all 0.3s ease;" placeholder="Enter your email"></InputText>
                        </div>
                        <div class="form-group mb-4">
                            <label class="form-label" style="color: #e2e8f0; font-weight: 500; margin-bottom: 0.5rem;">Password</label>
                            <input type="password" @bind="User.Password" class="form-control" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 0.75rem 1rem; color: white; transition: all 0.3s ease;" placeholder="Enter your password"></input>
                        </div>
                        <div class="form-group mt-4">
                            @if (ShowLoadingButton)
                            {
                                <ButtonLoadingSpinner> </ButtonLoadingSpinner>
                            }
                            else
                            {
                                <button class="btn w-100" type="submit" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; padding: 0.75rem; color: white; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                                    Sign In
                                </button>
                            }
                        </div>
                    </div>
                    <div class="card-footer text-center border-0" style="background: rgba(0,0,0,0.2); padding: 1.5rem;">
                        <span style="color: #cbd5e0; font-size: 0.95rem;">
                            Don't have an account?
                            <a class="btn-link" href="identity/account/register" style="color: #667eea; text-decoration: none; font-weight: 600; margin-left: 0.25rem; transition: color 0.3s ease;">Sign Up</a>
                        </span>
                        <div class="mt-3">
                            <ValidationSummary />
                        </div>
                    </div>
                </div>
            </EditForm>
        </div>
        <div class="col-lg-4"> </div>
    </div>
</div>

<style>
    .form-control:focus {
        background: rgba(255,255,255,0.15) !important;
        border-color: #667eea !important;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
        color: white !important;
    }

    .form-control::placeholder {
        color: rgba(255,255,255,0.5);
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6) !important;
    }

    .btn-link:hover {
        color: #764ba2 !important;
    }

    .card {
        animation: fadeInUp 0.6s ease-out;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

@code {
    public bool ShowLoadingButton { get; set; } = false;
    Login User = new();
    [CascadingParameter] public Task<AuthenticationState> AuthenticationState { get; set; }
    protected async override Task OnInitializedAsync()
    {
        await CheckUserAuthentication();
    }
    async Task HandleLogin()
    {
        ShowLoadingButton = true;
        var result = await accountService.SignInAsync(User);
        if (result.Flag)
        {
            await DisplayDialog(result.Message, "Login Success");
            var customAuthStateProvider = (CustomAuthenticationStateProvider)AuthStateProvider;
            await customAuthStateProvider.UpdateAuthenticationState(new UserSession()
            { Token = result.Token, RefreshToken = result.RefreshToken });
            NavManager.NavigateTo("/", forceLoad: true);
        }
        else
        {
            await DisplayDialog(result.Message, "Alert");
        }
        ShowLoadingButton = false;
    }
    private async Task DisplayDialog(string content, string title)
    {
        await dialogService.AlertAsync(content, title);
    }
    private async Task CheckUserAuthentication()
    {
        var user = (await AuthenticationState).User;
        bool isUserAuthenticated = user.Identity!.IsAuthenticated;
        if (isUserAuthenticated)
        {
            NavManager.NavigateTo("/home/dashboard");
        }
    }
}